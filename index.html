<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Board Test</title>
</head>

<body>
    <h1>Job Board Test</h1>

    <!-- ===== JOBS CRUD ===== -->
    <h2>Jobs</h2>
    <button onclick="loadJob(9)">Load Job</button>
    <div id="jobDetails"></div>

    <button onclick="createJob()">Create Job</button>
    <div id="postResult"></div>

    <button onclick="updateJob()">Update Last Created Job</button>
    <div id="putResult"></div>

    <button onclick="deleteJob()">Delete Last Created Job</button>
    <div id="deleteResult"></div>

    <!-- ===== APPLICATIONS CRUD ===== -->
    <h2>Applications</h2>
    <button onclick="loadApplication(14)">Load Application</button>
    <div id="applicationDetails"></div>

    <button onclick="createApplication()">Create Application</button>
    <div id="applicationPostResult"></div>

    <button onclick="updateApplication()">Update Last Created Application</button>
    <div id="applicationPutResult"></div>

    <button onclick="deleteApplication()">Delete Last Created Application</button>
    <div id="applicationDeleteResult"></div>

    <!-- ===== USERS CRUD ===== -->
    <h2>Users</h2>
    <button onclick="loadUser(2)">Load User</button>
    <div id="userDetails"></div>

    <button onclick="createUser()">Create User</button>
    <div id="userPostResult"></div>

    <button onclick="updateUser()">Update Last Created User</button>
    <div id="userPutResult"></div>

    <button onclick="deleteUser()">Delete Last Created User</button>
    <div id="userDeleteResult"></div>

    <script>
        // Variables globales pour suivre les derniers IDs créés
        let lastCreatedJobId = null;
        let lastCreatedApplicationId = null;
        let lastCreatedUserId = null;

        // =================== JOBS ===================
        function loadJob(jobId) {
            fetch(`http://localhost:3000/jobs/${jobId}`)
                .then(res => res.json())
                .then(job => {
                    if (job.message === "Job not found") {
                        document.getElementById('jobDetails').innerHTML = `<p style="color:red;">Job ${jobId} not found</p>`;
                        return;
                    }
                    document.getElementById('jobDetails').innerHTML = `
                        <h3>${job.title}</h3>
                        <p>${job.full_description}</p>
                        <p>Salary: ${job.salary}</p>
                        <p>Location: ${job.location}</p>
                        <p>Working hours: ${job.working_hours}</p>
                        <p>Company: ${job.company_name}</p>
                    `;
                })
                .catch(err => console.error(err));
        }

        function createJob() {
            fetch('http://localhost:3000/jobs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_id: 1,
                    title: "Backend Developer " + Math.floor(Math.random() * 100),
                    short_description: "Work on server-side code",
                    full_description: "Node.js, Express, SQL",
                    salary: "$60k-$80k",
                    location: "Remote",
                    working_hours: "Full-time"
                })
            })
                .then(res => res.json())
                .then(data => {
                    lastCreatedJobId = data.id;
                    document.getElementById('postResult').innerText = `✅ Job created with ID: ${data.id}`;
                });
        }

        function updateJob() {
            if (!lastCreatedJobId) {
                alert("⚠️ Create a job first!");
                return;
            }
            fetch(`http://localhost:3000/jobs/${lastCreatedJobId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_id: 1,
                    title: "Frontend Developer Updated",
                    short_description: "Updated description",
                    full_description: "Updated full description",
                    salary: "$55k-$75k",
                    location: "New York, NY",
                    working_hours: "Full-time"
                })
            })
                .then(res => res.json())
                .then(data => document.getElementById('putResult').innerText = data.message);
        }

        function deleteJob() {
            if (!lastCreatedJobId) {
                alert("⚠️ No job to delete!");
                return;
            }
            fetch(`http://localhost:3000/jobs/${lastCreatedJobId}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('deleteResult').innerText = data.message;
                    lastCreatedJobId = null;
                });
        }

        // =================== APPLICATIONS ===================
        function loadApplication(appId) {
            fetch(`http://localhost:3000/applications/${appId}`)
                .then(res => res.json())
                .then(app => {
                    if (app.message === "Application not found") {
                        document.getElementById('applicationDetails').innerHTML = `<p style="color:red;">Application ${appId} not found</p>`;
                        return;
                    }
                    document.getElementById('applicationDetails').innerHTML = `
                        <p><strong>ID:</strong> ${app.id}</p>
                        <p><strong>Job ID:</strong> ${app.job_id}</p>
                        <p><strong>User ID:</strong> ${app.user_id}</p>
                        <p><strong>Message:</strong> ${app.message}</p>
                        <p><strong>Status:</strong> ${app.status || "pending"}</p>
                    `;
                })
                .catch(err => console.error(err));
        }

        function createApplication() {
            fetch('http://localhost:3000/applications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    job_id: 9,
                    user_id: 2,
                    message: "Excited to apply!"
                })
            })
                .then(res => res.json())
                .then(data => {
                    lastCreatedApplicationId = data.id;
                    document.getElementById('applicationPostResult').innerText = `✅ Application created with ID: ${data.id}`;
                });
        }

        function updateApplication() {
            if (!lastCreatedApplicationId) {
                alert("⚠️ Create an application first!");
                return;
            }
            fetch(`http://localhost:3000/applications/${lastCreatedApplicationId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    job_id: 9,
                    user_id: 2,
                    message: "Updated message",
                    status: "reviewed"
                })
            })
                .then(res => res.json())
                .then(data => document.getElementById('applicationPutResult').innerText = data.message);
        }

        function deleteApplication() {
            if (!lastCreatedApplicationId) {
                alert("⚠️ No application to delete!");
                return;
            }
            fetch(`http://localhost:3000/applications/${lastCreatedApplicationId}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('applicationDeleteResult').innerText = data.message;
                    lastCreatedApplicationId = null;
                });
        }

        // =================== USERS ===================
        function loadUser(userId) {
            fetch(`http://localhost:3000/users/${userId}`)
                .then(res => res.json())
                .then(user => {
                    if (user.message === "User not found") {
                        document.getElementById('userDetails').innerHTML = `<p style="color:red;">User ${userId} not found</p>`;
                        return;
                    }
                    document.getElementById('userDetails').innerHTML = `
                        <p><strong>ID:</strong> ${user.id}</p>
                        <p><strong>Name:</strong> ${user.full_name}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Role:</strong> ${user.role}</p>
                        <p><strong>Status:</strong> ${user.status || "active"}</p>
                    `;
                })
                .catch(err => console.error(err));
        }

        function createUser() {
            fetch('http://localhost:3000/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    full_name: "New User " + Math.floor(Math.random() * 1000),
                    email: "user" + Math.floor(Math.random() * 1000) + "@example.com",
                    password: "password123",
                    role: "applicant"
                })
            })
                .then(res => res.json())
                .then(data => {
                    lastCreatedUserId = data.id;
                    document.getElementById('userPostResult').innerText = `✅ User created with ID: ${data.id}`;
                });
        }

        function updateUser() {
            if (!lastCreatedUserId) {
                alert("⚠️ Create a user first!");
                return;
            }
            fetch(`http://localhost:3000/users/${lastCreatedUserId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    full_name: "Alice Updated",
                    email: "alice" + Math.floor(Math.random() * 1000) + "@example.com",
                    password: "newpassword",
                    role: "admin"
                })
            })
                .then(res => res.json())
                .then(data => document.getElementById('userPutResult').innerText = data.message);
        }

        function deleteUser() {
            if (!lastCreatedUserId) {
                alert("⚠️ No user to delete!");
                return;
            }
            fetch(`http://localhost:3000/users/${lastCreatedUserId}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('userDeleteResult').innerText = data.message;
                    lastCreatedUserId = null;
                });
        }
    </script>

    <hr>
    <h2>Job List with Apply Button</h2>
    <div id="jobList"></div>

    <script>
        // =================== STEP 5 ===================
        async function loadJobList() {
            const res = await fetch('http://localhost:3000/jobs');
            const jobs = await res.json();
            const container = document.getElementById('jobList');
            container.innerHTML = "";

            if (jobs.length === 0) {
                container.innerHTML = "<p>No jobs available yet.</p>";
                return;
            }

            jobs.forEach(job => {
                const div = document.createElement('div');
                div.style.border = "1px solid #ccc";
                div.style.margin = "10px 0";
                div.style.padding = "10px";
                div.style.borderRadius = "6px";
                div.innerHTML = `
                <h3>${job.title}</h3>
                <p>${job.short_description}</p>
                <p><strong>Location:</strong> ${job.location}</p>
                <p><strong>Salary:</strong> ${job.salary}</p>
                <button onclick="toggleApplyForm(${job.id}, '${job.title}')">Apply</button>
                <div id="applyForm-${job.id}" style="display:none; margin-top:10px;">
                    <input type="text" id="name-${job.id}" placeholder="Full name" required><br>
                    <input type="email" id="email-${job.id}" placeholder="Email" required><br>
                    <input type="text" id="phone-${job.id}" placeholder="Phone"><br>
                    <textarea id="message-${job.id}" placeholder="Your message" required></textarea><br>
                    <button onclick="sendApplication(${job.id})">Send Application</button>
                    <p id="applyResult-${job.id}" style="margin-top:5px;"></p>
                </div>
            `;
                container.appendChild(div);
            });
        }

        function toggleApplyForm(jobId) {
            const form = document.getElementById(`applyForm-${jobId}`);
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        }

        async function sendApplication(jobId) {
            const name = document.getElementById(`name-${jobId}`).value;
            const email = document.getElementById(`email-${jobId}`).value;
            const phone = document.getElementById(`phone-${jobId}`).value;
            const message = document.getElementById(`message-${jobId}`).value;
            const result = document.getElementById(`applyResult-${jobId}`);

            if (!name || !email || !message) {
                result.style.color = "red";
                result.innerText = "⚠️ Please fill in all required fields.";
                return;
            }

            try {
                // Step 1: Create or get existing user
                let userRes = await fetch('http://localhost:3000/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: name,
                        email,
                        phone,
                        password: "default123",
                        role: "applicant"
                    })
                });

                if (!userRes.ok) {
                    throw new Error("User creation failed (" + userRes.status + ")");
                }

                let userData = await userRes.json();


                // If email already exists, get existing user from DB
                if (userData.error === "Email already exists") {
                    const usersRes = await fetch('http://localhost:3000/users');
                    const users = await usersRes.json();
                    const existingUser = users.find(u => u.email === email);
                    if (!existingUser) throw new Error("Existing user not found");
                    userData = existingUser;
                }

                // Step 2: Create application
                const appRes = await fetch('http://localhost:3000/applications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: jobId,
                        user_id: userData.id,
                        message
                    })
                });

                const appData = await appRes.json();
                if (appData.error) throw new Error(appData.error);

                result.style.color = "green";
                result.innerText = `✅ Application submitted successfully! (ID: ${appData.id})`;
            } catch (err) {
                console.error(err);
                result.style.color = "red";
                result.innerText = "❌ Error submitting application.";
            }
        }

        // Charger la liste au démarrage
        loadJobList();
    </script>



</body>

</html>